# Rules for where jobs can run

###
## Job variables:
##   VTK_CI_RUN_ALWAYS
##     Set to "true" if the job should always run.
##   VTK_CI_RUN_MANUALLY
##     Set to "true" if the job should be manually triggered in MRs. These jobs
##     will also be delayed for branch update pipelines
##   VTK_CI_MERGED_ONLY
##     Set to "true" to make the job only run for merged pipelines.
##   VTK_CI_NIGHTLY_ONLY
##     Set to "true" if the job should only run for nightly pipelines.
##   VTK_CI_RELEASE_ONLY
##     Set to "true" if the job should only run for release pipelines.
##   VTK_CI_DOCUMENTATION_UPLOAD
##     Set to "true" if the job uploads documentation.
##   VTK_CI_WEEKLY_UPLOAD
##     Set to "true" if the job performs a weekly upload.
## Pipeline variables:
##   ENABLE_DOCUMENTATION_UPLOAD
##     Set to "true" when documentation upload jobs should be performed.
##   ENABLE_WEEKLY_UPLOAD
##     Set to "true" when weekly upload jobs should be performed.
##   ENABLE_ONLY_JOBS
##     Set to regex in the format of /regex/ that selects the only jobs to enable in the pipeline.
####


variables:
    VTK_CI_PIPELINE_NAME: "VTK $CI_COMMIT_REF_NAME Pipeline"

# When to even consider running a pipeline.
workflow:
    name: "${VTK_CI_PIPELINE_NAME}"
    rules:
        # Run for merge requests.
        - if: '$CI_MERGE_REQUEST_ID'
          when: always
          auto_cancel:
              # Cancel all pipeline jobs if a new commit comes in on the branch/tag.
              on_new_commit: interruptible
          variables:
              VTK_CI_PIPELINE_NAME: "VTK MR !$CI_MERGE_REQUEST_IID Pipeline"
        # If this is not a MR, do not run for other projects.
        - if: '$CI_PROJECT_PATH != "vtk/vtk"'
          when: never
        # Run for schedules.
        - if: '$CI_PIPELINE_SOURCE == "schedule"'
          when: always
          auto_cancel:
              # Never cancel scheduled pipelines because of new commits.
              on_new_commit: none
          variables:
              VTK_CI_PIPELINE_NAME: "VTK $CI_PIPELINE_SCHEDULE_DESCRIPTION Scheduled Pipeline"
        # Run for protected branches.
        - if: '$CI_COMMIT_REF_PROTECTED == "true"'
          when: always
          auto_cancel:
              # Cancel all pipeline jobs if a new commit comes in on the branch.
              on_new_commit: interruptible
          variables:
              VTK_CI_PIPELINE_NAME: "VTK Protected Pipeline for $CI_COMMIT_REF_NAME"
        # Run for tags.
        - if: '$CI_COMMIT_TAG'
          when: always
          variables:
              VTK_CI_PIPELINE_NAME: "VTK Pipeline for tag $CI_COMMIT_TAG"
        # Skip pipelines in all other cases.
        - when: never

# Discover code changes
.changes: &code_change
    paths:
        # Ignore the documentation directory.
        - '!Documentation/**/*'
        - '**/*'
        - '.*'                # any hidden file is touched
        - '.*/**/*'           # any file within a hidden directory

.rules:
    rules:
        # Mechanism to only enable set of jobs
        - if: '$ENABLE_ONLY_JOBS && $CI_JOB_NAME !~ $ENABLE_ONLY_JOBS'
          when: never
        - if: '$ENABLE_ONLY_JOBS && $CI_JOB_NAME =~ $ENABLE_ONLY_JOBS'
          when: always
        # Some jobs always run.
        - if: '$VTK_CI_RUN_ALWAYS == "true"'
          when: always
        # Release-only jobs never run on MRs.
        - if: '$CI_MERGE_REQUEST_ID && $VTK_CI_RELEASE_ONLY == "true"'
          when: never
        # Merged-only jobs never run on MRs.
        - if: '$CI_MERGE_REQUEST_ID && $VTK_CI_MERGED_ONLY == "true"'
          when: never
        # MRs use manual triggers, but only if there are code changes.
        - if: '$CI_MERGE_REQUEST_ID && $VTK_CI_RUN_MANUALLY == "true"'
          changes: *code_change
          when: manual
        # Normal jobs run automatically, but only if there are code changes.
        - if: '$CI_MERGE_REQUEST_ID'
          changes: *code_change
          when: on_success
        # Any other jobs on a MR do not run.
        - if: '$CI_MERGE_REQUEST_ID'
          when: never
        # Jobs on a tag run right away.
        - if: '$CI_COMMIT_TAG'
          when: on_success
        # Any release-only jobs do not run without a tag.
        - if: '$VTK_CI_RELEASE_ONLY == "true"'
          when: never
        # Skip schedule jobs without a schedule.
        - if: '$CI_PIPELINE_SOURCE != "schedule" && $VTK_CI_NIGHTLY_ONLY == "true"'
          when: never
        # Documentation upload jobs require an enable flag.
        - if: '$VTK_CI_DOCUMENTATION_UPLOAD == "true" && $ENABLE_DOCUMENTATION_UPLOAD != "true"'
          when: never
        # Weekly upload jobs require an enable flag.
        - if: '$VTK_CI_WEEKLY_UPLOAD == "true" && $ENABLE_WEEKLY_UPLOAD != "true"'
          when: never
        # Scheduled jobs run automatically.
        - if: '$CI_PIPELINE_SOURCE == "schedule"'
          when: on_success
        # Manual jobs run delayed (e.g., merges to branches)
        - if: '$VTK_CI_RUN_MANUALLY == "true"'
          when: delayed
          start_in: 4 hours
        # Normal jobs on the project run automatically.
        - when: on_success

###
## Rules shortcuts for wheels
###
.wheels_retry_policy:
  retry:
    max: 2
    # We need to explicitly specify gitlab-(runner/instance) errors to avoid
    # triggering retries due to script_failures (devs errors). The reason for
    # this is that Gitlab does not current currently support conditionals for
    # retry, this is, we cannot set retry for scheduled jobs only. Thus,
    # enabling script_failures would probably resulting in hogging our CI
    # resources in MR pipelines.
    when:
      - api_failure
      - data_integrity_failure
      - job_execution_timeout
      - runner_system_failure
      - scheduler_failure
      - stuck_or_timeout_failure
      - unknown_failure

.rules_variables_wheel_latest_build:
    extends:
        - .wheels_retry_policy
        - .rules
    variables:
        VTK_CI_RUN_MANUALLY: "true"

# No-op but needed for consistency
.rules_variables_wheel_latest_test:
    extends:
        - .wheels_retry_policy
        - .rules

.rules_variables_wheel_previous_build:
    extends:
        - .wheels_retry_policy
        - .rules
    variables:
        VTK_CI_MERGED_ONLY: "true"
        VTK_CI_RUN_MANUALLY: "true"

.rules_variables_wheel_previous_test:
    extends:
        - .wheels_retry_policy
        - .rules
    variables:
        VTK_CI_MERGED_ONLY: "true"

.rules_variables_wheel_older_build:
    extends:
        - .wheels_retry_policy
        - .rules
    variables:
        VTK_CI_MERGED_ONLY: "true"
        VTK_CI_NIGHTLY_ONLY: "true"
        VTK_CI_RUN_MANUALLY: "true"

.rules_variables_wheel_older_test:
    extends:
        - .wheels_retry_policy
        - .rules
    variables:
        VTK_CI_MERGED_ONLY: "true"
        VTK_CI_NIGHTLY_ONLY: "true"

.rules_variables_wheel_weekly_build:
    extends:
        - .wheels_retry_policy
        - .rules
    variables:
        VTK_CI_MERGED_ONLY: "true"
        VTK_CI_RUN_MANUALLY: "true"
        VTK_CI_WEEKLY_UPLOAD: "true"

.rules_variables_wheel_weekly_test:
    extends:
        - .wheels_retry_policy
        - .rules
    variables:
        VTK_CI_MERGED_ONLY: "true"
        VTK_CI_WEEKLY_UPLOAD: "true"
